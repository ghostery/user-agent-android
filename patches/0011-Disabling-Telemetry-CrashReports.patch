From f4ed5fc0aece00c33b3a884a6192a9ad36035a5b Mon Sep 17 00:00:00 2001
From: Sam Macbeth <sam@cliqz.com>
Date: Mon, 3 Aug 2020 16:46:47 +0200
Subject: Disabling Telemetry & CrashReports

---
 .../org/mozilla/fenix/FenixApplication.kt     |  6 +---
 .../org/mozilla/fenix/components/Analytics.kt | 29 +++++--------------
 .../fenix/crashes/DummyCrashReporter.kt       | 19 ++++++++++++
 app/src/main/res/xml/preferences.xml          | 10 -------
 5 files changed, 29 insertions(+), 37 deletions(-)
 create mode 100644 app/src/main/java/org/mozilla/fenix/crashes/DummyCrashReporter.kt

diff --git a/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt b/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt
index 848ec3a1f..612bb2dcb 100644
--- a/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt
+++ b/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt
@@ -168,7 +168,7 @@ open class FenixApplication : LocaleAwareApplication(), Provider {
     @OptIn(DelicateCoroutinesApi::class) // GlobalScope usage
     @VisibleForTesting
     protected open fun initializeGlean() {
-        val telemetryEnabled = settings().isTelemetryEnabled
+        val telemetryEnabled = false

         logger.debug("Initializing Glean (uploadEnabled=$telemetryEnabled})")

@@ -459,10 +459,6 @@ open class FenixApplication : LocaleAwareApplication(), Provider {
     }

     private fun setupCrashReporting() {
-        components
-            .analytics
-            .crashReporter
-            .install(this)
     }

     protected open fun initializeNimbus() {

diff --git a/fenix/app/src/main/java/org/mozilla/fenix/components/Analytics.kt b/fenix/app/src/main/java/org/mozilla/fenix/components/Analytics.kt
index abfd470ac..48a72f57d 100644
--- a/fenix/app/src/main/java/org/mozilla/fenix/components/Analytics.kt
+++ b/fenix/app/src/main/java/org/mozilla/fenix/components/Analytics.kt
@@ -30,6 +30,7 @@ import org.mozilla.fenix.components.metrics.InstallReferrerMetricsService
 import org.mozilla.fenix.components.metrics.MetricController
 import org.mozilla.fenix.components.metrics.MetricsStorage
 import org.mozilla.fenix.crashes.CrashFactCollector
+import org.mozilla.fenix.crashes.DummyCrashReporter
 import org.mozilla.fenix.experiments.createNimbus
 import org.mozilla.fenix.ext.components
 import org.mozilla.fenix.ext.settings
@@ -49,10 +49,6 @@ class Analytics(
 ) {
     val crashReporter: CrashReporter by lazyMonitored {
         val services = mutableListOf<CrashReporterService>()
-        val distributionId = when (Config.channel.isMozillaOnline) {
-            true -> "MozillaOnline"
-            false -> "Mozilla"
-        }

         if (isSentryEnabled()) {
             // We treat caught exceptions similar to debug logging.
@@ -76,21 +72,10 @@ class Analytics(
             )

             services.add(sentryService)
+        } else {
+            services.add(DummyCrashReporter())
         }

-        // The name "Fenix" here matches the product name on Socorro and is unrelated to the actual app name:
-        // https://bugzilla.mozilla.org/show_bug.cgi?id=1523284
-        val socorroService = MozillaSocorroService(
-            context,
-            appName = "Fenix",
-            version = MOZ_APP_VERSION,
-            buildId = MOZ_APP_BUILDID,
-            vendor = MOZ_APP_VENDOR,
-            releaseChannel = MOZ_UPDATE_CHANNEL,
-            distributionId = distributionId,
-        )
-        services.add(socorroService)
-
         val intent = Intent(context, HomeActivity::class.java).apply {
             flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP
         }
@@ -109,11 +94,11 @@ class Analytics(
         CrashReporter(
             context = context,
             services = services,
-            telemetryServices = listOf(GleanCrashReporterService(context)),
+            telemetryServices = listOf(),
             shouldPrompt = CrashReporter.Prompt.ALWAYS,
             promptConfiguration = CrashReporter.PromptConfiguration(
                 appName = context.getString(R.string.app_name),
-                organizationName = "Mozilla",
+                organizationName = "Ghostery",
             ),
             enabled = true,
             nonFatalCrashIntent = pendingIntent,
@@ -135,17 +120,9 @@ class Analytics(

     val metrics: MetricController by lazyMonitored {
         MetricController.create(
-            listOf(
-                GleanMetricsService(context),
-                AdjustMetricsService(
-                    application = context as Application,
-                    storage = metricsStorage,
-                    crashReporter = crashReporter,
-                ),
-                InstallReferrerMetricsService(context),
-            ),
-            isDataTelemetryEnabled = { context.settings().isTelemetryEnabled },
-            isMarketingDataTelemetryEnabled = { context.settings().isMarketingTelemetryEnabled },
+            listOf(),
+            isDataTelemetryEnabled = { false },
+            isMarketingDataTelemetryEnabled = { false },
             context.settings(),
         )
     }
diff --git a/fenix/app/src/main/java/org/mozilla/fenix/crashes/DummyCrashReporter.kt b/fenix/app/src/main/java/org/mozilla/fenix/crashes/DummyCrashReporter.kt
new file mode 100644
index 000000000..de5b53ff5
--- /dev/null
+++ b/fenix/app/src/main/java/org/mozilla/fenix/crashes/DummyCrashReporter.kt
@@ -0,0 +1,19 @@
+package org.mozilla.fenix.crashes
+
+import mozilla.components.lib.crash.Crash
+import mozilla.components.lib.crash.service.CrashReporterService
+import mozilla.components.concept.base.crash.Breadcrumb
+
+class DummyCrashReporter : CrashReporterService {
+    override val id: String = "dummy"
+
+    override val name: String = "dummy"
+
+    override fun createCrashReportUrl(identifier: String): String? = null
+
+    override fun report(throwable: Throwable, breadcrumbs: ArrayList<Breadcrumb>): String? = null
+
+    override fun report(crash: Crash.NativeCodeCrash): String? = null
+
+    override fun report(crash: Crash.UncaughtExceptionCrash): String? = null
+}
\ No newline at end of file
diff --git a/fenix/app/src/main/java/org/mozilla/fenix/settings/SettingsFragment.kt b/fenix/app/src/main/java/org/mozilla/fenix/settings/SettingsFragment.kt
index bb1e1fd1f9..765524168e 100644
--- a/fenix/app/src/main/java/org/mozilla/fenix/settings/SettingsFragment.kt
+++ b/fenix/app/src/main/java/org/mozilla/fenix/settings/SettingsFragment.kt
@@ -491,7 +491,6 @@ class SettingsFragment : PreferenceFragmentCompat() {
         setupGeckoLogsPreference(requireContext().settings())
         setupAllowDomesticChinaFxaServerPreference()
         setupHttpsOnlyPreferences()
-        setupNotificationPreference()
         setupSearchPreference()
         setupHomepagePreference()
         setupTrackingProtectionPreference()
diff --git a/fenix/app/src/main/res/xml/preferences.xml b/fenix/app/src/main/res/xml/preferences.xml
index 5cc4db58d..42e670dbe 100644
--- a/fenix/app/src/main/res/xml/preferences.xml
+++ b/fenix/app/src/main/res/xml/preferences.xml
@@ -130,16 +130,6 @@
             app:iconSpaceReserved="false"
             android:title="@string/preferences_delete_browsing_data_on_quit" />

-        <androidx.preference.Preference
-            android:key="@string/pref_key_notifications"
-            app:iconSpaceReserved="false"
-            android:title="@string/preferences_notifications" />
-
-        <androidx.preference.Preference
-            android:key="@string/pref_key_data_choices"
-            app:iconSpaceReserved="false"
-            android:title="@string/preferences_data_collection" />
-
     </androidx.preference.PreferenceCategory>

     <PreferenceCategory
--
2.37.2

