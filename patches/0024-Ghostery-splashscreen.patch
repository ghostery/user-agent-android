From 74004011a21f0e34038f00716379299b4176b3c0 Mon Sep 17 00:00:00 2001
From: Stefano Pacifici <stefano.pacifici@gmail.com>
Date: Wed, 15 Jul 2020 16:11:33 +0200
Subject: Ghostery splashscreen

---
 app/src/main/AndroidManifest.xml                |  2 +-
 .../main/java/org/mozilla/fenix/HomeActivity.kt | 17 +++++++++++++++++
 .../drawable/splashscreen_window_background.xml | 15 +++++++++++++++
 app/src/main/res/values/styles.xml              |  5 +++++
 4 files changed, 38 insertions(+), 1 deletion(-)
 create mode 100644 app/src/main/res/drawable/splashscreen_window_background.xml

diff --git a/fenix/app/src/main/AndroidManifest.xml b/fenix/app/src/main/AndroidManifest.xml
index aab865ec7..6f41c3785 100644
--- a/fenix/app/src/main/AndroidManifest.xml
+++ b/fenix/app/src/main/AndroidManifest.xml
@@ -34,7 +34,7 @@
         android:label="@string/app_name"
         android:roundIcon="@mipmap/ic_launcher_round"
         android:supportsRtl="true"
-        android:theme="@style/NormalTheme"
+        android:theme="@style/LaunchTheme"
         android:usesCleartextTraffic="true"
         tools:ignore="UnusedAttribute">

diff --git a/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt b/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt
index 67352085f..49ddc0fc4 100644
--- a/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt
+++ b/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt
@@ -35,6 +35,8 @@ import androidx.navigation.fragment.NavHostFragment
 import androidx.navigation.ui.AppBarConfiguration
 import androidx.navigation.ui.NavigationUI
 import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.withContext
+import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.Dispatchers.IO
 import kotlinx.coroutines.ExperimentalCoroutinesApi
 import kotlinx.coroutines.Job
@@ -222,6 +224,8 @@ open class HomeActivity : LocaleAwareAppCompatActivity(), NavHostActivity {

         components.publicSuffixList.prefetch()

+        setTheme(R.style.NormalTheme)
+
         binding = ActivityHomeBinding.inflate(layoutInflater)
         setContentView(binding.root)
         ProfilerMarkers.addListenerForOnGlobalLayout(components.core.engine, this, binding.root)
@@ -361,6 +365,19 @@ open class HomeActivity : LocaleAwareAppCompatActivity(), NavHostActivity {

             DefaultBrowserNotificationWorker.setDefaultBrowserNotificationIfNeeded(applicationContext)
         }
+
+        // Now the app is started restore the original background to avoid weird splashscreen
+        // in oder Fragments
+        lifecycleScope.launch {
+            kotlinx.coroutines.delay(300L)
+            withContext(Dispatchers.Main) {
+                val ta = theme.obtainStyledAttributes(intArrayOf(R.attr.homeBackground))
+                ta.getDrawable(0)?.let {
+                        window.setBackgroundDrawable(it)
+                    }
+                ta.recycle()
+            }
+        }
     }

     override fun onStart() {
diff --git a/fenix/app/src/main/res/drawable/splashscreen_window_background.xml b/fenix/app/src/main/res/drawable/splashscreen_window_background.xml
new file mode 100644
index 000000000..b7c239b30
--- /dev/null
+++ b/fenix/app/src/main/res/drawable/splashscreen_window_background.xml
@@ -0,0 +1,15 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape xmlns:android="http://schemas.android.com/apk/res/android"
+            android:shape="rectangle">
+            <gradient
+                android:startColor="#00AEF0"
+                android:endColor="#fd7e75"
+                android:angle="-90"/>
+        </shape>
+    </item>
+
+    <item android:drawable="@drawable/big_ghosty"
+        android:gravity="center" />
+</layer-list>
diff --git a/fenix/app/src/main/res/values/styles.xml b/fenix/app/src/main/res/values/styles.xml
index d41c8647b..e078b6dad 100644
--- a/fenix/app/src/main/res/values/styles.xml
+++ b/fenix/app/src/main/res/values/styles.xml
@@ -128,6 +128,11 @@
         <item name="tabCounterTintColor">?attr/textPrimary</item>
     </style>

+    <style name="LaunchTheme" parent="NormalThemeBase">
+        <item name="android:statusBarColor">@android:color/transparent</item>
+        <item name="android:windowBackground">@drawable/splashscreen_window_background</item>
+    </style>
+
     <!-- A theme derived from the normal activity theme, but to look and behave like a dialog -->
     <style name="DialogActivityTheme" parent="NormalTheme">
         <item name="android:windowElevation">16dp</item>
--
2.37.2

