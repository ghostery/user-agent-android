From fe23534cdb6dbdd8ab4b2fe4770e3ed7fac2c506 Mon Sep 17 00:00:00 2001
From: Stefano Pacifici <stefano.pacifici@gmail.com>
Date: Wed, 15 Jul 2020 16:11:33 +0200
Subject: Ghostery splashscreen

---
 fenix/app/src/main/AndroidManifest.xml          |  2 +-
 .../main/java/org/mozilla/fenix/HomeActivity.kt | 17 +++++++++++++++++
 .../drawable/splashscreen_window_background.xml | 15 +++++++++++++++
 fenix/app/src/main/res/values/styles.xml        |  5 +++++
 4 files changed, 38 insertions(+), 1 deletion(-)
 create mode 100644 fenix/app/src/main/res/drawable/splashscreen_window_background.xml

diff --git a/fenix/app/src/main/AndroidManifest.xml b/fenix/app/src/main/AndroidManifest.xml
index a9d41ec477..21552d4313 100644
--- a/fenix/app/src/main/AndroidManifest.xml
+++ b/fenix/app/src/main/AndroidManifest.xml
@@ -48,7 +48,7 @@
         android:label="@string/app_name"
         android:roundIcon="@mipmap/ic_launcher_round"
         android:supportsRtl="true"
-        android:theme="@style/NormalTheme"
+        android:theme="@style/LaunchTheme"
         android:usesCleartextTraffic="true"
         tools:ignore="UnusedAttribute">
 
diff --git a/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt b/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt
index 5d1724eebb..e45cc28e7d 100644
--- a/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt
+++ b/fenix/app/src/main/java/org/mozilla/fenix/HomeActivity.kt
@@ -40,11 +40,13 @@ import androidx.navigation.fragment.NavHostFragment
 import androidx.navigation.ui.AppBarConfiguration
 import androidx.navigation.ui.NavigationUI
 import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.Dispatchers.IO
 import kotlinx.coroutines.Dispatchers.Main
 import kotlinx.coroutines.Job
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import mozilla.appservices.places.BookmarkRoot
 import mozilla.components.browser.state.action.ContentAction
 import mozilla.components.browser.state.action.SearchAction
@@ -253,6 +255,8 @@ open class HomeActivity : LocaleAwareAppCompatActivity(), NavHostActivity {
 
         components.publicSuffixList.prefetch()
 
+        setTheme(R.style.NormalTheme)
+
         // Changing a language on the Language screen restarts the activity, but the activity keeps
         // the old layout direction. We have to update the direction manually.
         window.decorView.layoutDirection = TextUtils.getLayoutDirectionFromLocale(Locale.getDefault())
@@ -469,6 +473,19 @@ open class HomeActivity : LocaleAwareAppCompatActivity(), NavHostActivity {
             components.settings,
             components.core.engine.settings,
         )
+
+        // Now the app is started restore the original background to avoid weird splashscreen
+        // in oder Fragments
+        lifecycleScope.launch {
+            kotlinx.coroutines.delay(300L)
+            withContext(Dispatchers.Main) {
+                val ta = theme.obtainStyledAttributes(intArrayOf(R.attr.homeBackground))
+                ta.getDrawable(0)?.let {
+                        window.setBackgroundDrawable(it)
+                    }
+                ta.recycle()
+            }
+        }
     }
 
     override fun onStart() {
diff --git a/fenix/app/src/main/res/drawable/splashscreen_window_background.xml b/fenix/app/src/main/res/drawable/splashscreen_window_background.xml
new file mode 100644
index 0000000000..b7c239b30c
--- /dev/null
+++ b/fenix/app/src/main/res/drawable/splashscreen_window_background.xml
@@ -0,0 +1,15 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape xmlns:android="http://schemas.android.com/apk/res/android"
+            android:shape="rectangle">
+            <gradient
+                android:startColor="#00AEF0"
+                android:endColor="#fd7e75"
+                android:angle="-90"/>
+        </shape>
+    </item>
+
+    <item android:drawable="@drawable/big_ghosty"
+        android:gravity="center" />
+</layer-list>
diff --git a/fenix/app/src/main/res/values/styles.xml b/fenix/app/src/main/res/values/styles.xml
index a8935dc9dc..03880976a3 100644
--- a/fenix/app/src/main/res/values/styles.xml
+++ b/fenix/app/src/main/res/values/styles.xml
@@ -130,6 +130,11 @@
         <item name="tabCounterTintColor">?attr/textPrimary</item>
     </style>
 
+    <style name="LaunchTheme" parent="NormalThemeBase">
+        <item name="android:statusBarColor">@android:color/transparent</item>
+        <item name="android:windowBackground">@drawable/splashscreen_window_background</item>
+    </style>
+
     <!-- A theme derived from the normal activity theme, but to look and behave like a dialog -->
     <style name="DialogActivityTheme" parent="NormalTheme">
         <item name="android:windowElevation">16dp</item>
-- 
2.39.2 (Apple Git-143)

