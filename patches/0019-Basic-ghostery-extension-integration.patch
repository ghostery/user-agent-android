From 297cd29740b035df54c23177b5c5c54bbcaff219 Mon Sep 17 00:00:00 2001
From: Sam Macbeth <sam@cliqz.com>
Date: Mon, 3 Aug 2020 18:31:14 +0200
Subject: Basic ghostery extension integration

---
 .gitignore                                             | 2 ++
 app/build.gradle                                       | 4 +++-
 app/src/main/java/org/mozilla/fenix/components/Core.kt | 9 +++++++++
 3 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/.gitignore b/.gitignore
index e297438d2..144c99ae4 100644
--- a/.gitignore
+++ b/.gitignore
@@ -103,4 +103,6 @@ test_artifacts/
 # Web extensions: manifest.json files are generated
 manifest.json
 
+# Ghostery extension
+/app/src/main/assets/extensions/ghostery
 /app/src/main/assets/extensions/ghostery-search
diff --git a/app/build.gradle b/app/build.gradle
index 260ba122d..13af364ab 100644
--- a/app/build.gradle
+++ b/app/build.gradle
@@ -179,7 +179,9 @@ android {
 
         // manifest.template.json is converted to manifest.json at build time.
         // No need to package the template in the APK.
-        ignoreAssetsPattern "manifest.template.json"
+        // default ignoreAssetsPattern list includes all files and folders starting with _
+        // that breaks webextensions i18n as traslation are located in _locales folder
+        ignoreAssetsPattern "manifest.template.json:!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~"
     }
 
     testOptions {
diff --git a/app/src/main/java/org/mozilla/fenix/components/Core.kt b/app/src/main/java/org/mozilla/fenix/components/Core.kt
index e7d94c6ee..cf0d4cc5c 100644
--- a/app/src/main/java/org/mozilla/fenix/components/Core.kt
+++ b/app/src/main/java/org/mozilla/fenix/components/Core.kt
@@ -8,6 +8,7 @@ import android.content.Context
 import android.content.res.Configuration
 import android.os.Build
 import android.os.StrictMode
+import android.util.Log
 import androidx.core.content.ContextCompat
 import mozilla.components.browser.engine.gecko.GeckoEngine
 import mozilla.components.browser.engine.gecko.fetch.GeckoViewFetchClient
@@ -145,6 +146,14 @@ class Core(
                 onError = { ext, throwable ->
                     Log.e("GHOSTERY", "Failed to install Ghostery Search webextension: $ext", throwable)
                 })
+
+            it.installWebExtension("Ghostery", "resource://android/assets/extensions/ghostery/",
+                onSuccess = {
+                    Log.d("GHOSTERY", "Installed Ghostery webextension: ${it.id}")
+                },
+                onError = { ext, throwable ->
+                    Log.e("GHOSTERY", "Failed to install Ghostery webextension: $ext", throwable)
+                })
         }
     }
 
-- 
2.34.1

