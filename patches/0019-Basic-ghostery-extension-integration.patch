From 6524a339a377b905bef1de88969b68a2b200a0a2 Mon Sep 17 00:00:00 2001
From: Sam Macbeth <sam@cliqz.com>
Date: Mon, 3 Aug 2020 18:31:14 +0200
Subject: Basic ghostery extension integration

---
 .gitignore                                             | 3 +++
 app/build.gradle                                       | 4 +++-
 app/src/main/java/org/mozilla/fenix/components/Core.kt | 9 +++++++++
 3 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/.gitignore b/.gitignore
index cd0e1c137..3991b83f3 100644
--- a/.gitignore
+++ b/.gitignore
@@ -102,3 +102,6 @@ test_artifacts/
 
 # Web extensions: manifest.json files are generated
 manifest.json
+
+# Ghostery extension
+/app/src/main/assets/extensions/ghostery
\ No newline at end of file
diff --git a/app/build.gradle b/app/build.gradle
index 260ba122d..13af364ab 100644
--- a/app/build.gradle
+++ b/app/build.gradle
@@ -179,7 +179,9 @@ android {
 
         // manifest.template.json is converted to manifest.json at build time.
         // No need to package the template in the APK.
-        ignoreAssetsPattern "manifest.template.json"
+        // default ignoreAssetsPattern list includes all files and folders starting with _
+        // that breaks webextensions i18n as traslation are located in _locales folder
+        ignoreAssetsPattern "manifest.template.json:!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~"
     }
 
     testOptions {
diff --git a/app/src/main/java/org/mozilla/fenix/components/Core.kt b/app/src/main/java/org/mozilla/fenix/components/Core.kt
index a8f5199c3..954066494 100644
--- a/app/src/main/java/org/mozilla/fenix/components/Core.kt
+++ b/app/src/main/java/org/mozilla/fenix/components/Core.kt
@@ -8,6 +8,7 @@ import android.content.Context
 import android.content.res.Configuration
 import android.os.Build
 import android.os.StrictMode
+import android.util.Log
 import androidx.core.content.ContextCompat
 import mozilla.components.browser.engine.gecko.GeckoEngine
 import mozilla.components.browser.engine.gecko.fetch.GeckoViewFetchClient
@@ -137,6 +138,14 @@ class Core(
             if (Config.channel.isNightlyOrDebug || Config.channel.isBeta) {
                 WebCompatReporterFeature.install(it, "fenix")
             }
+
+            it.installWebExtension("Ghostery", "resource://android/assets/extensions/ghostery/",
+                onSuccess = {
+                    Log.d("GHOSTERY", "Installed Ghostery webextension: ${it.id}")
+                },
+                onError = { ext, throwable ->
+                    Log.e("GHOSTERY", "Failed to install Ghostery webextension: $ext", throwable)
+                })
         }
     }
 
-- 
2.34.1

